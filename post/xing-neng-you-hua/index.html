<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta content="yes" name="apple-mobile-web-app-capable" />
<meta content="black" name="apple-mobile-web-app-status-bar-style" />
<meta name="referrer" content="never">
<meta name="keywords" content="">
<meta name="description" content="欢迎访问[鼓捣猫宁]的个人博客">
<meta name="author" content="kveln">
<title>性能优化 | 鼓捣猫宁</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css">
<link href="https://cdn.bootcss.com/font-awesome/5.11.2/css/all.min.css" rel="stylesheet">
<link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
<link
  href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800'
  rel='stylesheet' type='text/css'>
<link rel="alternate" type="application/rss+xml" title="性能优化 | 鼓捣猫宁 » Feed"
  href="https://daning.netlify.app/atom.xml">
<link rel="stylesheet"
  href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.15.10/build/styles/androidstudio.min.css">
<link href="https://daning.netlify.app/styles/main.css" rel="stylesheet">
<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets/highlight.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/850552586/ericamcdn@0.1/css/live2d.css">

<script>hljs.initHighlightingOnLoad();</script>

  <meta property="og:description" content="性能优化" />
  <meta property="og:url" content="https://daning.netlify.app/post/xing-neng-you-hua/" />
  <meta property="og:locale" content="zh-CN" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="鼓捣猫宁" />
  <!-- <script src="../assets/styles/scripts/tocScript.js"></script> -->
</head>

<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
  <div class="container">
    <a class="navbar-brand" href="https://daning.netlify.app">鼓捣猫宁</a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse"
      data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false"
      aria-label="Toggle navigation">
      Menu
      <i class="fas fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav ml-auto">
        
        <li class="nav-item">
          
          <a class="nav-link" href="/">首页</a>
          
        </li>
        
        <li class="nav-item">
          
          <a class="nav-link" href="/archives">归档</a>
          
        </li>
        
        <li class="nav-item">
          
          <a class="nav-link" href="/tags">标签</a>
          
        </li>
        
        <li class="nav-item">
          
          <a class="nav-link" href="/about">关于</a>
          
        </li>
        
        <li class="nav-item">
          <div class="gridea-search-container">
            <form id="gridea-search-form" style="position: relative" data-update="1770892703131"
              action="/search/index.html">
              <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="搜索文章" />
              <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
          </div>
        </li>
      </ul>
    </div>
  </div>
</nav>
  <!-- Page Header -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
  <div class="container">
    <a class="navbar-brand" href="https://daning.netlify.app">鼓捣猫宁</a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse"
      data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false"
      aria-label="Toggle navigation">
      Menu
      <i class="fas fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav ml-auto">
        
        <li class="nav-item">
          
          <a class="nav-link" href="/">首页</a>
          
        </li>
        
        <li class="nav-item">
          
          <a class="nav-link" href="/archives">归档</a>
          
        </li>
        
        <li class="nav-item">
          
          <a class="nav-link" href="/tags">标签</a>
          
        </li>
        
        <li class="nav-item">
          
          <a class="nav-link" href="/about">关于</a>
          
        </li>
        
        <li class="nav-item">
          <div class="gridea-search-container">
            <form id="gridea-search-form" style="position: relative" data-update="1770892703131"
              action="/search/index.html">
              <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="搜索文章" />
              <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
          </div>
        </li>
      </ul>
    </div>
  </div>
</nav>
<header class="masthead" style="background-image: url('https://daning.netlify.app/media/images/home-bg.jpg')">
  <div class="overlay"></div>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">
        
          <!-- 没Title为其他页面Header -->
          
            <!-- 没Title并且有headerType为Post：文章Header -->
            <div class="post-heading">
              <span class="tags">
                
                <a href="https://daning.netlify.app/tag/upAY8wL6E/" class="tag">OC</a>
                
              </span>
              <h1>性能优化</h1>
              <span class="meta">
                Posted on
                2022-01-31，12 min read
              </span>
            </div>
          
        
      </div>
    </div>
  </div>
</header>
  <!-- Post Content -->
  <article id="post-content-article">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto post-content-container">
          
          <!-- more -->
<h1 id="性能优化">性能优化</h1>
<h2 id="cpu-gpu">CPU &amp; GPU</h2>
<p><strong>CPU（Central Processing Unit，中央处理器）</strong></p>
<p>对象的创建和销毁、对象属性的调整、布局计算、文本的计算和排版、图片的格式转换和解码、图像的绘制（Core Graphics）</p>
<p><strong>GPU（Graphics Processing Unit，图形处理器）</strong></p>
<p>纹理渲染</p>
<figure data-type="image" tabindex="1"><img src="https://s1.ax1x.com/2022/04/06/qvVcSH.png" alt="屏幕成像流程图" loading="lazy"></figure>
<p><strong>iOS是双缓冲机制，分为前帧缓存 和 后帧缓存</strong></p>
<h2 id="卡顿产生的原因">卡顿产生的原因</h2>
<figure data-type="image" tabindex="2"><img src="https://s1.ax1x.com/2022/04/06/qvVBTK.png" alt="卡顿现象" loading="lazy"></figure>
<p>按照60fps的刷帧率，每隔16ms就会有一次VSync信号（上图中每两个VSync之间的时间长度 = 16ms）</p>
<p>解决卡顿的主要思路就是：尽可能的减少CPU、GPU的资源消耗</p>
<h2 id="卡顿优化-cpu">卡顿优化 - CPU</h2>
<ul>
<li>
<p>尽量用轻量级的对象，比如用不到事件处理的地方，可以考虑使用CALayer取代UIView</p>
</li>
<li>
<p>不要频繁地调用UIView的相关属性，比如frame、bounds、transform等属性，尽量减少不必要的修改</p>
</li>
<li>
<p>尽量提前计算好布局，在有需要时一次性调整对应的属性，不要多次修改属性</p>
</li>
<li>
<p>Autolayout会比直接设置frame消耗更多的CPU资源</p>
</li>
<li>
<p>图片的size最好刚好跟UIImageView的size保持一致</p>
</li>
<li>
<p>控制一下线程的最大并发数量</p>
</li>
<li>
<p>尽量把耗时的操作放到子线程</p>
<ul>
<li>文本处理（尺寸计算、绘制）</li>
<li>图片处理（解码、绘制）</li>
</ul>
</li>
</ul>
<p>图片异步解码 - 代码</p>
<pre><code>- (void)image
{
    UIImageView *imageView = [[UIImageView alloc] init];
    imageView.frame = CGRectMake(100, 100, 100, 56);
    [self.view addSubview:imageView];
    self.imageView = imageView;

    dispatch_async(dispatch_get_global_queue(0, 0), ^{
        // 获取CGImage
        CGImageRef cgImage = [UIImage imageNamed:@&quot;timg&quot;].CGImage;

        // alphaInfo
        CGImageAlphaInfo alphaInfo = CGImageGetAlphaInfo(cgImage) &amp; kCGBitmapAlphaInfoMask;
        BOOL hasAlpha = NO;
        if (alphaInfo == kCGImageAlphaPremultipliedLast ||
            alphaInfo == kCGImageAlphaPremultipliedFirst ||
            alphaInfo == kCGImageAlphaLast ||
            alphaInfo == kCGImageAlphaFirst) {
            hasAlpha = YES;
        }

        // bitmapInfo
        CGBitmapInfo bitmapInfo = kCGBitmapByteOrder32Host;
        bitmapInfo |= hasAlpha ? kCGImageAlphaPremultipliedFirst : kCGImageAlphaNoneSkipFirst;

        // size
        size_t width = CGImageGetWidth(cgImage);
        size_t height = CGImageGetHeight(cgImage);

        // context
        CGContextRef context = CGBitmapContextCreate(
                                                NULL, 
                                                width, 
                                                height, 
                                                8, 
                                                0, 
                                                CGColorSpaceCreateDeviceRGB(), 
                                                bitmapInfo);

        // draw
        CGContextDrawImage(context, CGRectMake(0, 0, width, height), cgImage);

        // get CGImage
        cgImage = CGBitmapContextCreateImage(context);

        // into UIImage
        UIImage *newImage = [UIImage imageWithCGImage:cgImage];

        // release
        CGContextRelease(context);
        CGImageRelease(cgImage);

        // back to the main thread
        dispatch_async(dispatch_get_main_queue(), ^{
            self.imageView.image = newImage;
        });
    });
}
</code></pre>
<h2 id="卡顿优化-gpu">卡顿优化 - GPU</h2>
<ul>
<li>尽量避免短时间内大量图片的显示，尽可能将多张图片合成一张进行显示</li>
<li>GPU能处理的最大纹理尺寸是4096x4096，一旦超过这个尺寸，就会占用CPU资源进行处理，所以纹理尽量不要超过这个尺寸</li>
<li>尽量减少视图数量和层次</li>
<li>减少透明的视图（alpha&lt;1），不透明的就设置opaque为YES</li>
<li>尽量避免出现离屏渲染</li>
</ul>
<h2 id="离屏渲染">离屏渲染</h2>
<ul>
<li>
<p>在OpenGL中，GPU有2种渲染方式</p>
<p>On-Screen Rendering：当前屏幕渲染，在当前用于显示的屏幕缓冲区进行渲染操作</p>
<p>Off-Screen Rendering：离屏渲染，在当前屏幕缓冲区以外新开辟一个缓冲区进行渲染操作</p>
</li>
<li>
<p>离屏渲染消耗性能的原因</p>
<p>需要创建新的缓冲区</p>
<p>离屏渲染的整个过程，需要多次切换上下文环境，先是从当前屏幕（On-Screen）切换到离屏（Off-Screen）；等到离屏渲染结束以后，将离屏缓冲区的渲染结果显示到屏幕上，又需要将上下文环境从离屏切换到当前屏幕</p>
</li>
<li>
<p>哪些操作会触发离屏渲染？</p>
<ul>
<li>光栅化，layer.shouldRasterize = YES</li>
<li>遮罩，layer.mask</li>
<li>圆角，同时设置layer.masksToBounds = YES、layer.cornerRadius大于0
<ul>
<li>考虑通过CoreGraphics绘制裁剪圆角</li>
<li>或者叫美工提供圆角图片</li>
</ul>
</li>
<li>阴影，layer.shadowXXX 如果设置了layer.shadowPath就不会产生离屏渲染</li>
</ul>
</li>
</ul>
<h2 id="卡顿检测">卡顿检测</h2>
<p>平时所说的“卡顿”主要是因为在主线程执行了比较耗时的操作</p>
<p>可以添加Observer到主线程RunLoop中，通过监听RunLoop状态切换的耗时，以达到监控卡顿的目的</p>
<blockquote>
<p>代码示例：LXDAppFluecyMonitor</p>
</blockquote>
<h2 id="耗电优化">耗电优化</h2>
<p><strong>尽可能降低CPU、GPU功耗</strong></p>
<p><strong>少用定时器</strong></p>
<p><strong>优化I/O操作</strong></p>
<ul>
<li>尽量不要频繁写入小数据，最好批量一次性写入</li>
<li>读写大量重要数据时，考虑用dispatch_io，其提供了基于GCD的异步操作文件I/O的API。用dispatch_io系统会优化磁盘访问</li>
<li>数据量比较大的，建议使用数据库（比如SQLite、CoreData）</li>
</ul>
<p><strong>网络优化</strong></p>
<ul>
<li>减少、压缩网络数据</li>
<li>如果多次请求的结果是相同的，尽量使用缓存</li>
<li>使用断点续传，否则网络不稳定时可能多次传输相同的内容</li>
<li>网络不可用时，不要尝试执行网络请求</li>
<li>让用户可以取消长时间运行或者速度很慢的网络操作，设置合适的超时时间</li>
<li>批量传输，比如，下载视频流时，不要传输很小的数据包，直接下载整个 文件或者一大块一大块地下载。如果下载广告，一次性多下载一些，然后再慢慢展示。如果下载电子邮件，一次下载多封，不要一封一封地下载</li>
</ul>
<p><strong>定位优化</strong></p>
<ul>
<li>如果只是需要快速确定用户位置，最好用CLLocationManager的requestLocation方法。定位完成后，会自动让定位硬件断电</li>
<li>如果不是导航应用，尽量不要实时更新位置，定位完毕就关掉定位服务</li>
<li>尽量降低定位精度，比如尽量不要使用精度最高的kCLLocationAccuracyBest</li>
<li>需要后台定位时，尽量设置pausesLocationUpdatesAutomatically为YES，如果用户不太可能移动的时候系统会自动暂停位置更新</li>
<li>尽量不要使用startMonitoringSignificantLocationChanges，优先考虑startMonitoringForRegion:</li>
</ul>
<p><strong>硬件检测优化</strong></p>
<p>用户移动、摇晃、倾斜设备时，会产生动作(motion)事件，这些事件由加速度计、陀螺仪、磁力计等硬件检测。在不需要检测的场合，应该及时关闭这些硬件</p>
<h2 id="app的启动">App的启动</h2>
<p><strong>APP的启动可以分为2种</strong></p>
<ul>
<li>冷启动（Cold Launch）：从零开始启动APP</li>
<li>热启动（Warm Launch）：APP已经在内存中，在后台存活着，再次点击图标启动APP</li>
</ul>
<p><strong>APP启动时间的优化，主要是针对冷启动进行优化</strong></p>
<p>通过添加环境变量可以打印出APP的启动时间分析（Edit scheme -&gt; Run -&gt; Arguments）</p>
<ul>
<li>DYLD_PRINT_STATISTICS设置为1</li>
<li>如果需要更详细的信息，那就将DYLD_PRINT_STATISTICS_DETAILS设置为1</li>
</ul>
<p><strong>App冷启动可以概括为3大阶段</strong></p>
<ul>
<li>dyld</li>
<li>runtime</li>
<li>main</li>
</ul>
<h3 id="app启动-dyld">App启动 - dyld</h3>
<p>dyld（dynamic link editor），Apple的动态链接器，可以用来装载Mach-O文件（可执行文件、动态库等）</p>
<p>启动APP时，dyld所做的事情有</p>
<ul>
<li>装载APP的可执行文件，同时会递归加载所有依赖的动态库</li>
<li>当dyld把可执行文件、动态库都装载完毕后，会通知Runtime进行下一步的处理</li>
</ul>
<h3 id="app启动-runtime">App启动 - runtime</h3>
<p>启动APP时，runtime所做的事情有</p>
<ul>
<li>调用map_images进行可执行文件内容的解析和处理</li>
<li>在load_images中调用call_load_methods，调用所有Class和Category的+load方法</li>
<li>进行各种objc结构的初始化（注册Objc类 、初始化类对象等等）</li>
<li>调用C++静态初始化器和__attribute__((constructor))修饰的函数</li>
</ul>
<p><strong>到此为止，可执行文件和动态库中所有的符号(Class，Protocol，Selector，IMP，…)都已经按格式成功加载到内存中，被runtime 所管理</strong></p>
<h3 id="app启动-main">App启动 - main</h3>
<ul>
<li>APP的启动由dyld主导，将可执行文件加载到内存，顺便加载所有依赖的动态库</li>
<li>并由runtime负责加载成objc定义的结构</li>
<li>所有初始化工作结束后，dyld就会调用main函数</li>
<li>接下来就是UIApplicationMain函数，AppDelegate的application:didFinishLaunchingWithOptions:方法</li>
</ul>
<h2 id="app的启动优化">App的启动优化</h2>
<ol>
<li>无用代码、无用的图片（资源）的删除</li>
<li>发挥多线程的优势</li>
<li>启动之后要显示的页面，尽量用纯代码写</li>
<li>业务逻辑的简化</li>
<li>二进制重排</li>
</ol>
<p>启动优化通常指的都是pre-main的优化，按照不同的阶段可以大致分为</p>
<h3 id="dyld">dyld</h3>
<ul>
<li>减少动态库、合并一些动态库（定期清理不必要的动态库）</li>
<li>减少Objc类、分类的数量、减少Selector数量（定期清理不必要的类、分类）</li>
<li>减少C++虚函数数量</li>
<li>Swift尽量使用struct</li>
</ul>
<h3 id="runtime">runtime</h3>
<p>用+initialize方法和dispatch_once取代所有的__attribute__((constructor))、C++静态构造器、ObjC的+load</p>
<h3 id="main">main</h3>
<p>在不影响用户体验的前提下，尽可能将一些操作延迟，不要全部都放在finishLaunching方法中<br>
按需加载</p>
<hr>
<img src="https://s1.ax1x.com/2022/04/06/qvVotS.png" alt="微信启动时间log" style="zoom:150%;" />
<p><strong>dylib loading - 动态库加载</strong></p>
<p>优化：减少动态库的使用</p>
<p><strong>rebase / binding - 偏移修正 / 符号绑定</strong></p>
<ul>
<li>
<p>偏移修正</p>
<ul>
<li>在MachO二进制文件里函数的实现地址 eg：0x0001</li>
<li>运行到内存中，利用<strong>ASLR（安全机制随机的值）</strong> eg：0x1000</li>
<li>运行时：函数实现真实地址 = 0x0001 + 0x1000 = 0x1001</li>
</ul>
</li>
<li>
<p>符号绑定</p>
<ul>
<li>MachO文件存在磁盘当中，当程序运行时，通过laodImage镜像到内存中（copy）</li>
<li>dyld进行符号绑定</li>
</ul>
<p>优化：减少动态库的使用</p>
</li>
</ul>
<p><strong>ObjC setup - OC创建</strong></p>
<p><strong>initializer - load函数 &amp; 构造函数</strong></p>
<p><strong>二进制重排</strong></p>
<p>将所有启动时需要调用的方法，排列在一起 - 二进制重排</p>
<h2 id="安装包瘦身">安装包瘦身</h2>
<p>安装包（IPA）主要由<strong>可执行文件</strong>、<strong>资源文件</strong>组成</p>
<p><strong>资源（图片、音频、视频等）</strong></p>
<ul>
<li>采取无损压缩</li>
<li>去除没有用到的资源： https://github.com/tinymind/LSUnusedResources</li>
</ul>
<p><strong>可执行文件瘦身</strong></p>
<ul>
<li>
<p>编译器优化</p>
<ul>
<li>Strip Linked Product、Make Strings Read-Only、Symbols Hidden by Default设置为YES</li>
<li>去掉异常支持，Enable C++ Exceptions、Enable Objective-C Exceptions设置为NO， Other C Flags添加-fno-exceptions</li>
</ul>
</li>
<li>
<p>利用AppCode（https://www.jetbrains.com/objc/）检测未使用的代码：菜单栏 -&gt; Code -&gt; Inspect Code</p>
</li>
<li>
<p>编写LLVM插件检测出重复代码、未被调用的代码</p>
</li>
</ul>
<h2 id="linkmap">LinkMap</h2>
<ul>
<li>生成LinkMap文件，可以查看可执行文件的具体组成（Build Settings -&gt; Linking -&gt; Path to Link Map File - 本地路径）</li>
<li>可借助第三方工具解析LinkMap文件： https://github.com/huanxsd/LinkMap</li>
</ul>
<h2 id="优化工具">优化工具</h2>
<ul>
<li>WSL_FPS (FPS检测)</li>
<li>LinkMap (每个文件大小)</li>
<li>LSUnusedResources (无用的文件)</li>
<li>appCode (同上)</li>
<li>MLeaksFinder</li>
<li>YYKit (异步渲染功能强大)</li>
<li>网络优化</li>
</ul>
<h2 id="循环引用">循环引用</h2>
<h2 id="1导致内存泄漏的几种方式">1.导致内存泄漏的几种方式？</h2>
<ul>
<li>野指针</li>
<li>循环引用</li>
<li>强引用</li>
<li>非OC对象的影响</li>
</ul>
<h2 id="2解决循环应用的方式">2.解决循环应用的方式？</h2>
<ul>
<li>__weak typeof(self) weakdSelf = self; 业务逻辑复杂的情况下，例如延迟操作容易引起对象提前释放，所以不建议这种方式</li>
<li>强引用、弱引用一起使用</li>
</ul>
<pre><code class="language-objc">self.name = @&quot;大宁宁&quot;;
__weak typeof(self) weakSelf = self;
self.block = ^{
  __strong typeof(self) strongSelf = weakSelf;
  dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(2 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
    NSLog(@&quot;%@&quot;,strongSelf.name); // self - nil name - nil
  });
};

self.block();
</code></pre>
<ul>
<li>中间变量，将self设置为局部变量，再block结束时置为nil</li>
</ul>
<pre><code class="language-objc">self.name = @&quot;大宁宁&quot;;
__block LGViewController *vc = self;
self.block = ^(){
  dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(2 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
    NSLog(@&quot;%@&quot;,vc.name);
      vc = nil;
  });
};
self.block();
</code></pre>
<ul>
<li>上一个方法改进（性能最高的一种方法）</li>
</ul>
<pre><code class="language-objc">self.name = @&quot;大宁宁&quot;;
    
self.blockVc = ^(LGViewController * vc) {
  dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(2 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
    NSLog(@&quot;%@&quot;,vc.name);
  });
};
self.blockVc(self);
</code></pre>
<h2 id="3强引用">3.强引用</h2>
<p>例如项目中遇到的NSTimer的使用，会导致强引用问题。（页面释放不掉，timer停不下来）</p>
<pre><code class="language-objc">@interface ViewController ()

@property (nonatomic, strong) NSTimer *timer;

@end

@implementation ViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    
    self.timer = [NSTimer scheduledTimerWithTimeInterval:2
                                                  target:self
                                                selector:@selector(fireHome)
                                                userInfo:nil
                                                 repeats:YES];
    [self.timer fireDate];
}

- (void)fireHome {
    NSLog(@&quot;来了&quot;);
}

- (void)dealloc{
    
    [self.timer invalidate];
    self.timer = nil;
    NSLog(@&quot;%s&quot;,__func__);
}
</code></pre>
<ul>
<li>
<p>第一种方法，调用iOS API</p>
<pre><code class="language-objc">  - (void)didMoveToParentViewController:(UIViewController *)parent {
  if (parent == nil) {
      [self.timer invalidate];
      self.timer = nil;
  }
}
</code></pre>
</li>
<li>
<p>第二种方法，中间变量，利用创建一个临时变量target，打破self持有timer，则self会被释放，随即timer在析构函数里也可被释放</p>
</li>
<li>
<p>第三种方法，iOS已经优化过的timerblockAPI</p>
<pre><code class="language-objc">self.timer = [NSTimer scheduledTimerWithTimeInterval:2 repeats:YES block:^(NSTimer * _Nonnull timer) {
      NSLog(@&quot;来了来了&quot;);
  }];
[self.timer fireDate];
// 析构函数里释放掉timer即可
</code></pre>
</li>
<li>
<p>第四种方法，NSProxy，利用消息转发机制</p>
</li>
</ul>
<h2 id="内存泄漏检测方式">内存泄漏检测方式</h2>
<ul>
<li>Xcode 设置Analyze during 'build' 为yes</li>
<li>Instruement</li>
<li>SDK MleakFind</li>
<li>dealloc</li>
</ul>
<h2 id="自定义-mleakfind">自定义 MleakFind</h2>
<blockquote>
<p>目标：监听UIViewContrller是否发生内存泄漏，（只考虑 push、pop）<br><br>
思路：我们在视图控制器弹出栈，并在这个视图完全销毁时，检测对象是否还活着<br><br>
步骤：<br></p>
<ul>
<li>1.交换视图控制器的viewWillAppear与swizzled_viewWillAppear方法，viewDidDisappear与swizzled_viewDidDisappear方法</li>
<li>2.使用关联方法，获取和设置视图控制进出栈状态</li>
<li>3.且在界面完全消失，并控制器的状态是出栈状态，这时，观察延时观察对象是否存活</li>
</ul>
</blockquote>

          <div class="toc-container"><ul class="markdownIt-TOC">
<li><a href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96">性能优化</a>
<ul>
<li><a href="#cpu-gpu">CPU &amp; GPU</a></li>
<li><a href="#%E5%8D%A1%E9%A1%BF%E4%BA%A7%E7%94%9F%E7%9A%84%E5%8E%9F%E5%9B%A0">卡顿产生的原因</a></li>
<li><a href="#%E5%8D%A1%E9%A1%BF%E4%BC%98%E5%8C%96-cpu">卡顿优化 - CPU</a></li>
<li><a href="#%E5%8D%A1%E9%A1%BF%E4%BC%98%E5%8C%96-gpu">卡顿优化 - GPU</a></li>
<li><a href="#%E7%A6%BB%E5%B1%8F%E6%B8%B2%E6%9F%93">离屏渲染</a></li>
<li><a href="#%E5%8D%A1%E9%A1%BF%E6%A3%80%E6%B5%8B">卡顿检测</a></li>
<li><a href="#%E8%80%97%E7%94%B5%E4%BC%98%E5%8C%96">耗电优化</a></li>
<li><a href="#app%E7%9A%84%E5%90%AF%E5%8A%A8">App的启动</a>
<ul>
<li><a href="#app%E5%90%AF%E5%8A%A8-dyld">App启动 - dyld</a></li>
<li><a href="#app%E5%90%AF%E5%8A%A8-runtime">App启动 - runtime</a></li>
<li><a href="#app%E5%90%AF%E5%8A%A8-main">App启动 - main</a></li>
</ul>
</li>
<li><a href="#app%E7%9A%84%E5%90%AF%E5%8A%A8%E4%BC%98%E5%8C%96">App的启动优化</a>
<ul>
<li><a href="#dyld">dyld</a></li>
<li><a href="#runtime">runtime</a></li>
<li><a href="#main">main</a></li>
</ul>
</li>
<li><a href="#%E5%AE%89%E8%A3%85%E5%8C%85%E7%98%A6%E8%BA%AB">安装包瘦身</a></li>
<li><a href="#linkmap">LinkMap</a></li>
<li><a href="#%E4%BC%98%E5%8C%96%E5%B7%A5%E5%85%B7">优化工具</a></li>
<li><a href="#%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8">循环引用</a></li>
<li><a href="#1%E5%AF%BC%E8%87%B4%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F">1.导致内存泄漏的几种方式？</a></li>
<li><a href="#2%E8%A7%A3%E5%86%B3%E5%BE%AA%E7%8E%AF%E5%BA%94%E7%94%A8%E7%9A%84%E6%96%B9%E5%BC%8F">2.解决循环应用的方式？</a></li>
<li><a href="#3%E5%BC%BA%E5%BC%95%E7%94%A8">3.强引用</a></li>
<li><a href="#%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E6%A3%80%E6%B5%8B%E6%96%B9%E5%BC%8F">内存泄漏检测方式</a></li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89-mleakfind">自定义 MleakFind</a></li>
</ul>
</li>
</ul>
</div>
          
          <hr />
          <p class="next-post">下一篇：
            <a href="https://daning.netlify.app/post/ios-qia-dun-hao-dian-deng-you-hua/">
              <span class="post-title">
                iOS 卡顿、耗电等优化&rarr;
              </span>
            </a>
          </p>
          
          <div class="comment" style="text-align: center;">
            
            <span id="/post/xing-neng-you-hua/" class="leancloud_visitors"
              data-flag-title="性能优化">
              <em class="post-meta-item-text">阅读量 </em>
              <i class="leancloud-visitors-count">loading...</i>
            </span>
            

            
            
            <script src='https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js'></script>

<style>
	div#vcomments{
		width:100%;
		max-width: 1000px;
		padding: 2.5%
	}
</style>


	<div id="vcomments"></div>

<script>
	new Valine({
		el: '#vcomments',
		appId: 'MAAasDLv2NYMtEEAn4QnnU3l-gzGzoHsz',
		appKey: 'dISXAmwDUYme6vJqsc5HgYw1',
		avatar: 'robohash',
		pageSize: 5,
		recordIp: false,
		placeholder: '来都来了，不留下点虎狼之词就走吗？',
		visitor: true,
	});
</script>

            
          </div>
        </div>
      </div>
  </article>
  <!-- Footer -->
  <footer>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <ul class="list-inline text-center">
            
            
            <li class="list-inline-item">
              <a href="https://github.com/NeedQuiet" target="_blank">
                <span class="fa-stack fa-lg">
                  <i class="fas fa-circle fa-stack-2x"></i>
                  <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
            
              
            
              
            
              
            
            <li class="list-inline-item">
              <a href="https://www.zhihu.com/people/da-ning-40" target="_blank">
                <span class="fa-stack fa-lg">
                  <i class="fas fa-circle fa-stack-2x"></i>
                  <i class="fab fa-zhihu fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
            
              
            
              
            
              
            
              
              <!-- <li class="list-inline-item">
              <a href="https://daning.netlify.app/atom.xml" target="_blank">
                <span class="fa-stack fa-lg">
                  <i class="fas fa-circle fa-stack-2x"></i>
                  <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
                </span>
              </a>
              </li> -->
          </ul>
          <p class="copyright text-muted">Copyright &copy;<span>鼓捣猫宁</span><br><a href="https://github.com/getgridea/gridea" class="Themeinfo">Powered by Gridea</a></p>
        </div>
      </div>
    </div>
   </footer>
  <!-- Bootstrap core JavaScript -->
  <script src="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
  <!-- <script src="https://daning.netlify.app/media/scripts/bootstrap.bundle.min.js"></script> -->
  <!-- Bootstrap core JavaScript -->
  <script src="https://cdn.jsdelivr.net/gh/Alanrk/clean-cdn@1.0/scripts/clean-blog.min.js"></script>
  <!-- <script src="https://daning.netlify.app/media/scripts/clean-blog.min.js"></script> -->
  <script src="//instant.page/3.0.0" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>
  <style type="text/css">a.back_to_top{text-decoration:none;position:fixed;bottom:40px;right:30px;background:#f0f0f0;height:40px;width:40px;border-radius:50%;line-height:36px;font-size:18px;text-align:center;transition-duration:.5s;transition-propety:background-color;display:none}a.back_to_top span{color:#888}a.back_to_top:hover{cursor:pointer;background:#dfdfdf}a.back_to_top:hover span{color:#555}@media print,screen and(max-width:580px){.back_to_top{display:none!important}}</style>
<a id="back_to_top" href="#" class="back_to_top">
  <span>▲</span></a>
<script>$(document).ready((function(_this) {
    return function() {
      var bt;
      bt = $('#back_to_top');
      if ($(document).width() > 480) {
        $(window).scroll(function() {
          var st;
          st = $(window).scrollTop();
          if (st > 30) {
            return bt.css('display', 'block')
          } else {
            return bt.css('display', 'none')
          }
        });
        return bt.click(function() {
          $('body,html').animate({
            scrollTop: 0
          },
          800);
          return false
        })
      }
    }
  })(this));</script>
  
  <div id="landlord-parent">
    <div id="landlord">
        <div class="message" style="opacity:0"></div>
        <canvas id="live2d" width="240" height="250" class="live2d"></canvas>
    </div>
</div>

<script type="text/javascript">
    if (/(iPhone|iPad|iPod|iOS|Android)/i.test(navigator.userAgent)) {
        //移动端
        console.log("------ 移动端");
    } else {
        console.log("------ PC端 " + navigator.userAgent);

        addScript("https://cdn.jsdelivr.net/gh/850552586/ericamcdn@0.1/js/live2d.js", () => {
            // 加载完成后再loadlive2d
            loadlive2d("live2d", "https://daning.netlify.app/media/live2d/assets/hijiki.model.json");
        });

        var home_Path = "https://daning.netlify.app/";
        addScript("https://daning.netlify.app/media/live2d/js/message.js", () => { });
    }

    // 插入js文件，完成后callback
    function addScript(jsfile, callback) {
        var landlord_parent = document.getElementById("landlord-parent");
        var script = document.createElement("script");
        script.type = "text/javascript";
        script.src = jsfile;
        landlord_parent.appendChild(script);
        script.onload = script.onreadystatechange = function () {
            if (!this.readyState || this.readyState === "loaded" || this.readyState === "complete") {
                script.onload = script.onreadystatechange = null;
                if (callback && typeof callback == "function") {
                    callback(); //window[callback]();如果传递字符串过来 调用window['函数名']() 调用方法
                }
            }
        };
    }
</script>
  
  <script src="https://daning.netlify.app/media/scripts/tocScript.js"></script>
</body>

</html>